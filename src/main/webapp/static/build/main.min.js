"use strict";var app=angular.module("app",["ngRoute","datepicker","ngTable","core"],function(e){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var r=function(e){var t,a,n,s,o,i,c,l="";for(t in e)if(a=e[t],a instanceof Array)for(c=0;c<a.length;++c)o=a[c],n=t+"["+c+"]",i={},i[n]=o,l+=r(i)+"&";else if(a instanceof Object)for(s in a)o=a[s],n=t+"["+s+"]",i={},i[n]=o,l+=r(i)+"&";else void 0!==a&&null!==a&&(l+=encodeURIComponent(t)+"="+encodeURIComponent(a)+"&");return l.length?l.substr(0,l.length-1):l};e.defaults.transformRequest=[function(e){return angular.isObject(e)&&"[object File]"!==String(e)?r(e):e}]});app.controller("MainCtrl",function(e,r,t){t.getUserInfo(function(r){e.user=r})});var fdRouterViewsBasepath="static/app/modules/";app.config(["$routeProvider",function(e){e.when("/",{templateUrl:fdRouterViewsBasepath+"formdesign/views/list.html",controller:"FormDesignListCtrl"}).when("/formdesign",{templateUrl:fdRouterViewsBasepath+"formdesign/views/list.html",controller:"FormDesignListCtrl"}).when("/formdesignedit/:id",{templateUrl:fdRouterViewsBasepath+"formdesign/views/design.html",controller:"FormDesignCtrl"}).when("/formdesignedit",{templateUrl:fdRouterViewsBasepath+"formdesign/views/design.html",controller:"FormDesignCtrl"}).when("/formdatalist/:formid",{templateUrl:fdRouterViewsBasepath+"formdesign/views/formdatalist.html",controller:"FormDataListCtrl"}).when("/usermgr/list",{templateUrl:fdRouterViewsBasepath+"usermgr/views/usermgr_list.html",controller:"UserMgrListCtrl"}).when("/usermgr/editUser/:id",{templateUrl:fdRouterViewsBasepath+"usermgr/views/usermgr_edituser.html",controller:"UserMgrEditUserCtrl"}).when("/usermgr/addUser",{templateUrl:fdRouterViewsBasepath+"usermgr/views/usermgr_edituser.html",controller:"UserMgrEditUserCtrl"}).when("/formreport/list",{templateUrl:fdRouterViewsBasepath+"formreport/views/formreport_list.html",controller:"FormReportListCtrl"}).otherwise({redirectTo:"/"})}]),app.filter("trustHtml",function(e){return function(r){return e.trustAsHtml(r)}}),angular.module("core",[]).directive("formresult",[function(){return{restrict:"A",templateUrl:"static/app/components/directives/core/formresult.html"}}]),angular.module("core",[]).directive("permission",["BaseInfoService",function(e){return{restrict:"A",link:function(r,t,a){var n=t.style.display;t.style.display="none",e.getUserInfo(function(e){var r=!1,s=!1,o=e.userType;if("1"!=o){var i=a.roles.split(",");if(i.length>0)for(var c in i){var l=i[c];if(l==o){r=!0;break}}{a.funid}s=!0,r&&s&&(t.style.display=n)}else t.style.display=n})}}}]),angular.module("datepicker",[]).directive("datepicker",[function(){return{restrict:"A",require:"ngModel",link:function(e,r,t,a){$(function(){r.datepicker({dateFormat:"yy-mm-dd",onSelect:function(r){e.$apply(function(){a.$setViewValue(r)})}})})}}}]),angular.module("page",[]).directive("fpage",[function(){return{restrict:"EA",templateUrl:"static/app/components/directives/fdpage/page.html",replace:!0,scope:{conf:"="},link:function(e){function r(){e.conf.currentPage=parseInt(e.conf.currentPage)?parseInt(e.conf.currentPage):1,e.conf.totalItems||(e.conf.totalItems=0),e.conf.totalItems=parseInt(e.conf.totalItems),e.conf.rememberPerPage?(parseInt(localStorage[e.conf.rememberPerPage])||(localStorage[e.conf.rememberPerPage]=parseInt(e.conf.itemsPerPage)?parseInt(e.conf.itemsPerPage):15),e.conf.itemsPerPage=parseInt(localStorage[e.conf.rememberPerPage])):e.conf.itemsPerPage=parseInt(e.conf.itemsPerPage)?parseInt(e.conf.itemsPerPage):15,e.conf.numberOfPages=Math.ceil(e.conf.totalItems/e.conf.itemsPerPage),e.conf.currentPage<1&&(e.conf.currentPage=1),e.conf.currentPage>e.conf.numberOfPages&&(e.conf.currentPage=e.conf.numberOfPages),e.jumpPageNum=e.conf.currentPage;for(var r,t=e.conf.perPageOptions.length,a=0;t>a;a++)e.conf.perPageOptions[a]==e.conf.itemsPerPage&&(r=!0);if(r||e.conf.perPageOptions.push(e.conf.itemsPerPage),e.conf.perPageOptions.sort(function(e,r){return e-r}),e.pageList=[],e.conf.numberOfPages<=e.conf.pagesLength)for(a=1;a<=e.conf.numberOfPages;a++)e.pageList.push(a);else{var n=(e.conf.pagesLength-1)/2;if(e.conf.currentPage<=n){for(a=1;n+1>=a;a++)e.pageList.push(a);e.pageList.push("..."),e.pageList.push(e.conf.numberOfPages)}else if(e.conf.currentPage>e.conf.numberOfPages-n){for(e.pageList.push(1),e.pageList.push("..."),a=n+1;a>=1;a--)e.pageList.push(e.conf.numberOfPages-a);e.pageList.push(e.conf.numberOfPages)}else{for(e.pageList.push(1),e.pageList.push("..."),a=Math.ceil(n/2);a>=1;a--)e.pageList.push(e.conf.currentPage-a);for(e.pageList.push(e.conf.currentPage),a=1;n/2>=a;a++)e.pageList.push(e.conf.currentPage+a);e.pageList.push("..."),e.pageList.push(e.conf.numberOfPages)}}e.conf.onChange&&e.conf.onChange(),e.$parent.conf=e.conf}e.changeCurrentPage=function(r){"..."!=r&&(e.conf.currentPage=r)},e.conf.pagesLength=parseInt(e.conf.pagesLength)?parseInt(e.conf.pagesLength):9,e.conf.pagesLength%2===0&&(e.conf.pagesLength=e.conf.pagesLength-1),e.conf.perPageOptions||(e.conf.perPageOptions=[10,15,20,30,50]),e.prevPage=function(){e.conf.currentPage>1&&(e.conf.currentPage-=1)},e.nextPage=function(){e.conf.currentPage<e.conf.numberOfPages&&(e.conf.currentPage+=1)},e.jumpToPage=function(){e.jumpPageNum=e.jumpPageNum.replace(/[^0-9]/g,""),""!==e.jumpPageNum&&(e.conf.currentPage=e.jumpPageNum)},e.changeItemsPerPage=function(){e.conf.rememberPerPage&&localStorage.removeItem(e.conf.rememberPerPage)},e.$watch(function(){var r=e.conf.currentPage+" "+e.conf.totalItems+" ";return r+=e.conf.rememberPerPage&&localStorage[e.conf.rememberPerPage]?localStorage[e.conf.rememberPerPage]:e.conf.itemsPerPage},r)}}}]),angular.module("core",[]).factory("BaseInfoService",["$http",function(e){var r=null;return{getUserInfo:function(t){r?data&&t(data):e.post("getLoginUser").success(function(e){e&&t(e)})}}}]),app.controller("FormReportListCtrl",function(e,r,t,a){var n=1,s=10;e.initParams=function(){e.queryParams={page:n,rows:s,isreload:!0}},e.initParams(),e.reload=function(){e.initParams(),e.tableParams.reload()},e.tableParams=new a({page:n,count:s},{total:0,getData:function(r,a){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=a.page(),e.queryParams.rows=a.count(),e.queryParams.total=a.total()),t.post("formdesign/getMyforms",e.queryParams).success(function(t){var n=t.pagingResult.total;e.queryParams.total=n,a.total(n),r.resolve(t.pagingResult.rows)})}})}),app.controller("FormDataListCtrl",function(e,r,t,a,n,s,o){var i=1,c=10;e.initParams=function(){e.queryParams={page:i,rows:c,formid:t.formid,isreload:!0}},e.initParams(),e.reload=function(){e.initParams(),e.tableParams.reload()},e.tableParams=new a({page:i,count:c},{total:0,getData:function(r,t){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=t.page(),e.queryParams.rows=t.count(),e.queryParams.total=t.total()),n.queryList(e.queryParams,function(a){var n=a.pagingResult.total;e.queryParams.total=n,t.total(n),r.resolve(a.pagingResult.rows)})}}),e.del=function(r){confirm("确认删除?")!==!1&&(r.isdeling=!0,o.del({id:r.id},function(){e.reload()}))},s.queryFormById({id:t.formid},function(r){e.formtitle=r.formResult.data.title,e.formdtcreate=r.formResult.data.dtCreate,e.formdtupdate=r.formResult.data.dtUpdate,e.formdtpub=r.formResult.data.dtPub,e.formFields=r.formFields})}),app.controller("FormDesignCtrl",function(e,r,t){function a(e,r){var t=/(\|-<span(((?!<span).)*plugins=\"(radios|checkboxs|select)\".*?)>(.*?)<\/span>-\||<(img|input|textarea|select).*?(<\/select>|<\/textarea>|\/>))/gi,a=/(\w+)=\"(.?|.+?)\"/gi,n=/<input.*?\/>/gi;r||(r=0);var s=e,o=new Array,i=new Object,c=0,l=0;e.replace(t,function(t,u,f,d,m,p,g){var P=new Array,h=new Object,v="",y="",b=!1,w=t,q=g?g:m;if("radios"==q||"checkboxs"==q?t=f:"select"==q&&(t=t.replace("|-",""),t=t.replace("-|","")),t.replace(a,function(e,t,a){"name"==t&&("NEWFIELD"==a&&(b=!0,r++,a="data_"+r),v=a),"select"==q&&"value"==t?(h[t]||(h[t]=""),h[t]+=y+a,y=","):h[t]=a;var n=new Object;n[t]=a,P.push(n)}),"checkboxs"==q){t=w,t=t.replace("|-",""),t=t.replace("-|","");var v="checkboxs_"+c;h.parse_name=v,h.name="",h.value="",h.content='<span plugins="checkboxs" valids="'+h.valids+'">';var L="",U="";p.replace(n,function(e){var t=!1,n=new Object;e.replace(a,function(e,a,s){"name"==a?("NEWFIELD"==s&&(t=!0,r++,s="data_"+r),h.name+=L+s,L=","):"value"==a&&(h.value+=U+s,U=","),n[a]=s}),h.options||(h.options=new Array),h.options.push(n),n.checked||(n.checked="");var s=n.checked?'checked="checked"':"";if(h.content+='<input type="checkbox" name="'+n.name+'" value="'+n.value+'" fieldname="'+h.fieldname+n.fieldname+'"'+s+"/>"+n.value+"&nbsp;",t){var o=new Object;o.name=n.name,o.plugins=h.plugins,o.fieldname=h.fieldname+n.fieldname,o.fielddesc=h.orgdesc,o.valids=h.valids,i[n.name]=o}}),h.content+="</span>",e=e.replace(t,h.content),s=s.replace(t,"{"+v+"}"),s=s.replace("{|-",""),s=s.replace("-|}",""),o[l]=h,c++}else if(v){if("radios"==q){t=w,t=t.replace("|-",""),t=t.replace("-|",""),h.value="",h.content='<span plugins="radios" name="'+h.name+'" valids="'+h.valids+'">';var C="";p.replace(n,function(e){var r=new Object;e.replace(a,function(e,t,a){"value"==t&&(h.value+=C+a,C=","),r[t]=a}),r.name=h.name,h.options||(h.options=new Array),h.options.push(r),r.checked||(r.checked="");var t=r.checked?'checked="checked"':"";h.content+='<input type="radio" name="'+h.name+'" value="'+r.value+'"  '+t+"/>"+r.value+"&nbsp;"}),h.content+="</span>"}else h.content=b?t.replace(/NEWFIELD/,v):t;if(e=e.replace(t,h.content),s=s.replace(t,"{"+v+"}"),s=s.replace("{|-",""),s=s.replace("-|}",""),b){var I=new Object;I.name=v,I.plugins=h.plugins,I.orgtype=h.orgtype,I.fieldname=h.fieldname,I.fielddesc=h.orgdesc,I.valids=h.valids,i[I.name]=I}o[l]=h}l++});var u=e.replace(/{\|-/g,"");u=u.replace(/-\|}/g,"");var f=new Object({fields:r,template:e,parse:u,data:o,add_fields:i});return JSON.stringify(f)}r.id&&(e.id=r.id),UE.delEditor("formdesigncontainer");var n=null;n=UE.getEditor("formdesigncontainer",{toolleipi:!0,initialFrameWidth:1024,initialFrameHeight:200,enableAutoSave:!1,enableContextMenu:!0,toolbars:[["fullscreen","undo","redo","|","bold","italic","underline","fontborder","strikethrough","removeformat","|","forecolor","backcolor","insertorderedlist","insertunorderedlist","|","fontfamily","fontsize","|","indent","|","justifyleft","justifycenter","justifyright","justifyjustify","|","link","unlink","|","horizontal","spechars","wordimage","|","inserttable","deletetable","mergecells","splittocells","|"]],wordCount:!1,elementPathEnabled:!1}),n.addListener("ready",function(){r.id&&t.post("formdesign/getformbyid",{id:r.id}).success(function(r){e.title=r.formResult.data.title,n.execCommand("focus"),n.setContent(r.formResult.data.contentSrc)})}),e.exec=function(e){n.execCommand(e)},e.save=function(){if(0!=confirm("确认保存?注意：保存之后原始表单以及对应表单已上报数据会清空。")){if(n.queryCommandState("source")&&n.execCommand("source"),void 0===e.title)return void alert("标题不能为空");if(e.title.length>50)return void alert("标题长度不能大于50个字符");if(n.hasContents()){n.sync();var r=n.getContent(),s=JSON.parse(a(r,0));e.issaving=!0,t.post("formdesign/add",{title:e.title,content:s.parse,contentSrc:r,fields:JSON.stringify(s.add_fields),id:e.id}).success(function(r){"0"==r.formResult.success?alert(r.formResult.message):(e.id=r.formResult.data,alert("保存成功")),e.issaving=!1}).error(function(){alert("保存失败"),e.issaving=!1})}else alert("内容不能为空")}},e.preview=function(){if(n.queryCommandState("source")&&n.execCommand("source"),!n.hasContents())return alert("内容不能为空！"),!1;n.sync();var r=n.getContent(),t=a(r,0);e.designZone=JSON.parse(t).parse,e.isDesignZoneActive=!0}}),app.controller("FormDesignListCtrl",function(e,r,t,a,n){e.reset=function(){e.searchTitle=null,e.dtCreateBegin=null,e.dtCreateEnd=null,e.dtPubBegin=null,e.dtPubEnd=null,e.ispub=null,e.pubtype=null};var s=1,o=10;e.queryParams={page:s,rows:o,isreload:!0},e.reload=function(){e.queryParams={page:e.queryParams.page,rows:e.queryParams.rows,dtcreate_begin:e.dtCreateBegin,dtcreate_end:e.dtCreateEnd,dtpub_begin:e.dtPubBegin,dtpub_end:e.dtPubEnd,ispub:e.ispub,title:e.searchTitle,pubtype:e.pubtype,isreload:!0},e.tableParams.reload()},e.tableParams=new t({page:s,count:o},{total:0,getData:function(r,t){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=t.page(),e.queryParams.rows=t.count(),e.queryParams.total=t.total()),a.queryList(e.queryParams,function(a){var n=a.pagingResult.total;e.queryParams.total=n,t.total(n),r.resolve(a.pagingResult.rows)})}}),e.pub=function(r,t){n.pub({id:r,type:t},function(){e.reload()})},e.canclepub=function(r){n.canclepub({id:r},function(){e.reload()})},e.del=function(r){confirm("确认删除?")!==!1&&(r.isdeling=!0,n.del({id:r.id},function(){e.reload()}))}}),app.factory("FormDataListService",["$http",function(e){return{queryList:function(r,t){e.post("formdesign/getformdatas",r).success(function(e){var r=[],a=e.pagingResult.rows;if(a&&a.length>0)for(var n in a){var s=a[n];r.push({id:s.id,dt_create:s.dt_create,form_data:JSON.parse(s.form_data)})}e.pagingResult.rows=r,t&&t(e)})}}}]),app.factory("FormDataService",["$http",function(e){return{del:function(r,t){e.post("formdesign/formdatadel",r).success(function(e){t&&t(e)})}}}]),app.factory("FormDesignListService",["$http",function(e){return{queryList:function(r,t){e.post("formdesign/getforms",r).success(function(e){t&&t(e)})}}}]),app.factory("FormDesignService",["$http",function(e){return{queryFormById:function(r,t){e.post("formdesign/getformbyid",r).success(function(e){var r=JSON.parse(e.formResult.data.fields),a=[],n=5,s=0;$.each(r,function(e,r){return s>=n?!1:(s++,void(r&&r.fielddesc&&a.push({name:e,desc:r.fielddesc})))}),e.formFields=a,t&&t(e)})},del:function(r,t){e.post("formdesign/del",r).success(function(e){t&&t(e)})},pub:function(r,t){e.post("formdesign/pub",r).success(function(e){t&&t(e)})},canclepub:function(r,t){e.post("formdesign/canclepub",r).success(function(e){t&&t(e)})}}}]),app.controller("UserMgrEditUserCtrl",function(e,r,t,a){r.id?(e.id=r.id,t.post("usermgr/getUserById",{id:e.id}).success(function(r){r.createTime=null,r.updateTime=null,e.user=r})):a.getUserInfo(function(r){e.user={userType:"1"==r.userType?"2":"3"}}),e.saveUser=function(){e.formresult=null;var r=$("#usermgr-list-form").isHappy({fields:{loginName:{required:!0,maxlength:20},userName:{required:!0,maxlength:20},birthday:{dateISO:!0},orgCode:{maxlength:40},department:{maxlength:100},comment:{maxlength:100}}});r&&(e.isrequest=!0,t.post("usermgr/editUser",e.user).success(function(r){e.formresult=r,r.data&&(e.user.id=r.data.id),e.isrequest=!1}))}}),app.controller("UserMgrListCtrl",function(e,r,t,a){var n=1,s=10;e.queryParams={page:n,rows:s,isreload:!0},e.reload=function(){e.queryParams={page:e.queryParams.page,rows:e.queryParams.rows,username:e.searchUserName,loginname:e.searchLoginName,usertype:e.searchUserType,isDisabled:e.searchIsDisabled,isreload:!0},e.tableParams.reload()},e.tableParams=new a({page:n,count:s},{total:0,getData:function(r,a){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=a.page(),e.queryParams.rows=a.count(),e.queryParams.total=a.total()),t.post("usermgr/getUserList",e.queryParams).success(function(t){var n=t.total;e.queryParams.total=n,a.total(n),r.resolve(t.rows)})}}),e.delUser=function(r){confirm("确认删除?")!==!1&&t.post("usermgr/delUser",{id:r.id}).success(function(){e.reload()})},e.disabledUser=function(r){confirm("确认锁定?")!==!1&&t.post("usermgr/disabledUser",{id:r.id}).success(function(){e.reload()})},e.enableUser=function(r){t.post("usermgr/enableUser",{id:r.id}).success(function(){e.reload()})}});