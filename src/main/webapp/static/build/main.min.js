"use strict";var app=angular.module("app",["ngRoute","ngTable"],function(e){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var t=function(e){var r,a,n,s,o,i,l,u="";for(r in e)if(a=e[r],a instanceof Array)for(l=0;l<a.length;++l)o=a[l],n=r+"["+l+"]",i={},i[n]=o,u+=t(i)+"&";else if(a instanceof Object)for(s in a)o=a[s],n=r+"["+s+"]",i={},i[n]=o,u+=t(i)+"&";else void 0!==a&&null!==a&&(u+=encodeURIComponent(r)+"="+encodeURIComponent(a)+"&");return u.length?u.substr(0,u.length-1):u};e.defaults.transformRequest=[function(e){return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e}]});app.controller("MainCtrl",function(e,t){e.to=function(e){t.path(e)}}),app.controller("IndexCtrl",function(){}),app.controller("CustomMgrCtrl",function(){});var fdRouterViewsBasepath="static/app/modules/";app.config(["$routeProvider",function(e){e.when("/",{templateUrl:fdRouterViewsBasepath+"index/views/index.html",controller:"IndexCtrl"}).when("/custommgr",{templateUrl:fdRouterViewsBasepath+"custommgr/views/custommgr.html",controller:"CustomMgrCtrl"}).otherwise({redirectTo:"/"})}]),app.filter("trustHtml",function(e){return function(t){return e.trustAsHtml(t)}}),angular.module("core",[]).directive("formresult",[function(){return{restrict:"A",templateUrl:"static/app/components/directives/core/formresult.html"}}]),angular.module("core",[]).directive("permission",["BaseInfoService",function(e){return{restrict:"A",link:function(t,r,a){var n=r.style.display;r.style.display="none",e.getUserInfo(function(e){var t=!1,s=!1,o=e.userType;if("1"!=o){var i=a.roles.split(",");if(i.length>0)for(var l in i){var u=i[l];if(u==o){t=!0;break}}{a.funid}s=!0,t&&s&&(r.style.display=n)}else r.style.display=n})}}}]),angular.module("datepicker",[]).directive("datepicker",[function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,a){$(function(){t.datepicker({dateFormat:"yy-mm-dd",onSelect:function(t){e.$apply(function(){a.$setViewValue(t)})}})})}}}]),app.factory("BaseInfoService",["$http",function(e){var t=null;return{getUserInfo:function(r){t?data&&r(data):e.post("getLoginUser").success(function(e){e&&r(e)})}}}]),app.controller("FormDataListCtrl",function(e,t,r,a,n,s,o){var i=1,l=10;e.initParams=function(){e.queryParams={page:i,rows:l,formid:r.formid,isreload:!0}},e.initParams(),e.reload=function(){e.initParams(),e.tableParams.reload()},e.tableParams=new a({page:i,count:l},{total:0,getData:function(t,r){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=r.page(),e.queryParams.rows=r.count(),e.queryParams.total=r.total()),n.queryList(e.queryParams,function(a){var n=a.pagingResult.total;e.queryParams.total=n,r.total(n),t.resolve(a.pagingResult.rows)})}}),e.del=function(t){confirm("确认删除?")!==!1&&(t.isdeling=!0,o.del({id:t.id},function(){e.reload()}))},s.queryFormById({id:r.formid},function(t){e.formtitle=t.formResult.data.title,e.formdtcreate=t.formResult.data.dtCreate,e.formdtupdate=t.formResult.data.dtUpdate,e.formdtpub=t.formResult.data.dtPub,e.formFields=t.formFields})}),app.controller("FormDesignCtrl",function(e,t,r){function a(e,t){var r=/(\|-<span(((?!<span).)*plugins=\"(radios|checkboxs|select)\".*?)>(.*?)<\/span>-\||<(img|input|textarea|select).*?(<\/select>|<\/textarea>|\/>))/gi,a=/(\w+)=\"(.?|.+?)\"/gi,n=/<input.*?\/>/gi;t||(t=0);var s=e,o=new Array,i=new Object,l=0,u=0;e.replace(r,function(r,c,d,f,p,m,g){var y=new Array,v=new Object,b="",h="",P=!1,q=r,w=g?g:p;if("radios"==w||"checkboxs"==w?r=d:"select"==w&&(r=r.replace("|-",""),r=r.replace("-|","")),r.replace(a,function(e,r,a){"name"==r&&("NEWFIELD"==a&&(P=!0,t++,a="data_"+t),b=a),"select"==w&&"value"==r?(v[r]||(v[r]=""),v[r]+=h+a,h=","):v[r]=a;var n=new Object;n[r]=a,y.push(n)}),"checkboxs"==w){r=q,r=r.replace("|-",""),r=r.replace("-|","");var b="checkboxs_"+l;v.parse_name=b,v.name="",v.value="",v.content='<span plugins="checkboxs" valids="'+v.valids+'">';var C="",U="";m.replace(n,function(e){var r=!1,n=new Object;e.replace(a,function(e,a,s){"name"==a?("NEWFIELD"==s&&(r=!0,t++,s="data_"+t),v.name+=C+s,C=","):"value"==a&&(v.value+=U+s,U=","),n[a]=s}),v.options||(v.options=new Array),v.options.push(n),n.checked||(n.checked="");var s=n.checked?'checked="checked"':"";if(v.content+='<input type="checkbox" name="'+n.name+'" value="'+n.value+'" fieldname="'+v.fieldname+n.fieldname+'"'+s+"/>"+n.value+"&nbsp;",r){var o=new Object;o.name=n.name,o.plugins=v.plugins,o.fieldname=v.fieldname+n.fieldname,o.fielddesc=v.orgdesc,o.valids=v.valids,i[n.name]=o}}),v.content+="</span>",e=e.replace(r,v.content),s=s.replace(r,"{"+b+"}"),s=s.replace("{|-",""),s=s.replace("-|}",""),o[u]=v,l++}else if(b){if("radios"==w){r=q,r=r.replace("|-",""),r=r.replace("-|",""),v.value="",v.content='<span plugins="radios" name="'+v.name+'" valids="'+v.valids+'">';var k="";m.replace(n,function(e){var t=new Object;e.replace(a,function(e,r,a){"value"==r&&(v.value+=k+a,k=","),t[r]=a}),t.name=v.name,v.options||(v.options=new Array),v.options.push(t),t.checked||(t.checked="");var r=t.checked?'checked="checked"':"";v.content+='<input type="radio" name="'+v.name+'" value="'+t.value+'"  '+r+"/>"+t.value+"&nbsp;"}),v.content+="</span>"}else v.content=P?r.replace(/NEWFIELD/,b):r;if(e=e.replace(r,v.content),s=s.replace(r,"{"+b+"}"),s=s.replace("{|-",""),s=s.replace("-|}",""),P){var R=new Object;R.name=b,R.plugins=v.plugins,R.orgtype=v.orgtype,R.fieldname=v.fieldname,R.fielddesc=v.orgdesc,R.valids=v.valids,i[R.name]=R}o[u]=v}u++});var c=e.replace(/{\|-/g,"");c=c.replace(/-\|}/g,"");var d=new Object({fields:t,template:e,parse:c,data:o,add_fields:i});return JSON.stringify(d)}t.id&&(e.id=t.id),UE.delEditor("formdesigncontainer");var n=null;n=UE.getEditor("formdesigncontainer",{toolleipi:!0,initialFrameWidth:1024,initialFrameHeight:200,enableAutoSave:!1,enableContextMenu:!0,toolbars:[["fullscreen","undo","redo","|","bold","italic","underline","fontborder","strikethrough","removeformat","|","forecolor","backcolor","insertorderedlist","insertunorderedlist","|","fontfamily","fontsize","|","indent","|","justifyleft","justifycenter","justifyright","justifyjustify","|","link","unlink","|","horizontal","spechars","wordimage","|","inserttable","deletetable","mergecells","splittocells","|"]],wordCount:!1,elementPathEnabled:!1}),n.addListener("ready",function(){t.id&&r.post("formdesign/getformbyid",{id:t.id}).success(function(t){e.title=t.formResult.data.title,n.execCommand("focus"),n.setContent(t.formResult.data.contentSrc)})}),e.exec=function(e){n.execCommand(e)},e.save=function(){if(0!=confirm("确认保存?注意：保存之后原始表单以及对应表单已上报数据会清空。")){if(n.queryCommandState("source")&&n.execCommand("source"),void 0===e.title)return void alert("标题不能为空");if(e.title.length>50)return void alert("标题长度不能大于50个字符");if(n.hasContents()){n.sync();var t=n.getContent(),s=JSON.parse(a(t,0));e.issaving=!0,r.post("formdesign/add",{title:e.title,content:s.parse,contentSrc:t,fields:JSON.stringify(s.add_fields),id:e.id}).success(function(t){"0"==t.formResult.success?alert(t.formResult.message):(e.id=t.formResult.data,alert("保存成功")),e.issaving=!1}).error(function(){alert("保存失败"),e.issaving=!1})}else alert("内容不能为空")}},e.preview=function(){if(n.queryCommandState("source")&&n.execCommand("source"),!n.hasContents())return alert("内容不能为空！"),!1;n.sync();var t=n.getContent(),r=a(t,0);e.designZone=JSON.parse(r).parse,e.isDesignZoneActive=!0}}),app.controller("FormDesignListCtrl",function(e,t,r,a,n){e.reset=function(){e.searchTitle=null,e.dtCreateBegin=null,e.dtCreateEnd=null,e.dtPubBegin=null,e.dtPubEnd=null,e.ispub=null,e.pubtype=null};var s=1,o=10;e.queryParams={page:s,rows:o,isreload:!0},e.reload=function(){e.queryParams={page:e.queryParams.page,rows:e.queryParams.rows,dtcreate_begin:e.dtCreateBegin,dtcreate_end:e.dtCreateEnd,dtpub_begin:e.dtPubBegin,dtpub_end:e.dtPubEnd,ispub:e.ispub,title:e.searchTitle,pubtype:e.pubtype,isreload:!0},e.tableParams.reload()},e.tableParams=new r({page:s,count:o},{total:0,getData:function(t,r){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=r.page(),e.queryParams.rows=r.count(),e.queryParams.total=r.total()),a.queryList(e.queryParams,function(a){var n=a.pagingResult.total;e.queryParams.total=n,r.total(n),t.resolve(a.pagingResult.rows)})}}),e.pub=function(t,r){n.pub({id:t,type:r},function(){e.reload()})},e.canclepub=function(t){n.canclepub({id:t},function(){e.reload()})},e.del=function(t){confirm("确认删除?")!==!1&&(t.isdeling=!0,n.del({id:t.id},function(){e.reload()}))}}),app.factory("FormDataListService",["$http",function(e){return{queryList:function(t,r){e.post("formdesign/getformdatas",t).success(function(e){var t=[],a=e.pagingResult.rows;if(a&&a.length>0)for(var n in a){var s=a[n];t.push({id:s.id,dt_create:s.dt_create,form_data:JSON.parse(s.form_data)})}e.pagingResult.rows=t,r&&r(e)})}}}]),app.factory("FormDataService",["$http",function(e){return{del:function(t,r){e.post("formdesign/formdatadel",t).success(function(e){r&&r(e)})}}}]),app.factory("FormDesignListService",["$http",function(e){return{queryList:function(t,r){e.post("formdesign/getforms",t).success(function(e){r&&r(e)})}}}]),app.factory("FormDesignService",["$http",function(e){return{queryFormById:function(t,r){e.post("formdesign/getformbyid",t).success(function(e){var t=JSON.parse(e.formResult.data.fields),a=[],n=5,s=0;$.each(t,function(e,t){return s>=n?!1:(s++,void(t&&t.fielddesc&&a.push({name:e,desc:t.fielddesc})))}),e.formFields=a,r&&r(e)})},del:function(t,r){e.post("formdesign/del",t).success(function(e){r&&r(e)})},pub:function(t,r){e.post("formdesign/pub",t).success(function(e){r&&r(e)})},canclepub:function(t,r){e.post("formdesign/canclepub",t).success(function(e){r&&r(e)})}}}]),app.controller("FormReportListCtrl",function(e,t,r,a){var n=1,s=10;e.initParams=function(){e.queryParams={page:n,rows:s,isreload:!0}},e.initParams(),e.reload=function(){e.initParams(),e.tableParams.reload()},e.tableParams=new a({page:n,count:s},{total:0,getData:function(t,a){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=a.page(),e.queryParams.rows=a.count(),e.queryParams.total=a.total()),r.post("formdesign/getMyforms",e.queryParams).success(function(r){var n=r.pagingResult.total;e.queryParams.total=n,a.total(n),t.resolve(r.pagingResult.rows)})}})}),app.controller("UserMgrEditUserCtrl",function(e,t,r,a){t.id?(e.id=t.id,r.post("usermgr/getUserById",{id:e.id}).success(function(t){t.createTime=null,t.updateTime=null,e.user=t})):a.getUserInfo(function(t){e.user={userType:"1"==t.userType?"2":"3"}}),e.saveUser=function(){e.formresult=null;var t=$("#usermgr-list-form").isHappy({fields:{loginName:{required:!0,maxlength:20},userName:{required:!0,maxlength:20},birthday:{dateISO:!0},orgCode:{maxlength:40},department:{maxlength:100},comment:{maxlength:100}}});t&&(e.isrequest=!0,r.post("usermgr/editUser",e.user).success(function(t){e.formresult=t,t.data&&(e.user.id=t.data.id),e.isrequest=!1}))}}),app.controller("UserMgrListCtrl",function(e,t,r,a){var n=1,s=10;e.queryParams={page:n,rows:s,isreload:!0},e.reload=function(){e.queryParams={page:e.queryParams.page,rows:e.queryParams.rows,username:e.searchUserName,loginname:e.searchLoginName,usertype:e.searchUserType,isDisabled:e.searchIsDisabled,isreload:!0},e.tableParams.reload()},e.tableParams=new a({page:n,count:s},{total:0,getData:function(t,a){e.queryParams.isreload?e.queryParams.isreload=!1:(e.queryParams.page=a.page(),e.queryParams.rows=a.count(),e.queryParams.total=a.total()),r.post("usermgr/getUserList",e.queryParams).success(function(r){var n=r.total;e.queryParams.total=n,a.total(n),t.resolve(r.rows)})}}),e.delUser=function(t){confirm("确认删除?")!==!1&&r.post("usermgr/delUser",{id:t.id}).success(function(){e.reload()})},e.disabledUser=function(t){confirm("确认锁定?")!==!1&&r.post("usermgr/disabledUser",{id:t.id}).success(function(){e.reload()})},e.enableUser=function(t){r.post("usermgr/enableUser",{id:t.id}).success(function(){e.reload()})}});